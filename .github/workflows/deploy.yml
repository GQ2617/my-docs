name: Deploy VitePress to GitHub Pages

# 触发条件：推送到 main 分支，或手动触发
on:
  push:
    branches: [main]
  workflow_dispatch: # 新增：允许手动触发，方便测试

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions: # 核心：显式声明权限，解决 token 权限不足问题
      contents: write # 必须！授予读写仓库内容的权限
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取所有提交记录
          persist-credentials: false # 避免凭证冲突

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm cache clean --force
          npm install --force

      - name: Build VitePress site
        run: npm run docs:build

      - name: Configure Git # 新增：配置 git 用户名和邮箱，避免推送时身份验证失败
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }} # 替换为 personal_token（兼容新版）
          publish_dir: ./docs/.vitepress/dist
          publish_branch: gh-pages
          force_orphan: true # 强制创建孤立分支，避免冲突
          commit_message: "docs: deploy ${{ github.sha }}" # 明确提交信息